# MVtoolbox
## 项目介绍
### 目的
- 熟练掌握Qt widget开发。
	- 灵活运用Qt独有的特性，**信号-槽机制，事件，元对象系统，插件系统等**。
	- 对Qt中**图形视图模块**有基本的运用。
	- 熟练使用基本的类，如窗口类、线程等
	- 能够使用assistant和qt creator快捷键等工具提升开发效率。
	- 能够初步地进行**多线程编程**。
	- 能够总结提炼出一个Qt Gui开发普适的方法论。
- 基本掌握qt creator的debug方法，能够通过*断点调试，打印日志*等方式解决问题。
- 熟悉软件开发的流程，以*软件工程*的理论指导项目开发。
- 能够对opencv常见类和算法进行基本使用。
### 功能
- 软件能够通过加载插件的方式拓展可用的图像处理算法。
- 图像显示窗口，支持图像缩放和平移。
- 缩略图窗口，显示已选中的图像。
- 单次运行和循环运行
### 软件演示
![image](https://github.com/JLer-chen/MVtoolbox/assets/53033561/ffa87d28-a435-45ca-9c97-69588c472943)


## 架构
### 面向对象分析
- 从软件使用者角度对系统运行流程进行uml建模，活动图（activity diagram）
![Pasted image 20240115152159](https://github.com/JLer-chen/MVtoolbox/assets/53033561/1f5140e7-ceec-4ccb-acf2-88df21409987)

### 面向对象设计
- 根据需求和活动图进行类的设计：
	- 模块划分
		1. 菜单栏，位于主界面上方部分。用于设置算法处理后的图像存储路径，以及控制算法是单次运行和是循环运行
		2. 插件管理者，位于主界面左半部分。显示已加载的算法树，并提供具体算法的参数参数详情页。
		3. 视图，位于主界面右上部分。用于显示在缩略图框中被选择的原始图像，以及算法处理后的图像。支持图片缩放和平移。
		4. 缩略图框，位于主界面右下部分。以缩略图的形式显示所选择的本地图片。
		5. 生产者，将从本地读图的操作封装成一个类。
		6. 消费者，将读取图片、调用插件的操作封装成一个类
	- 菜单栏，用信号-槽机制，接收用户请求，slot函数由mianwindow实现。 
	- 插件管理者：
		1. 遵循*单一职责原则*，让这个类实现算法插件的加载、初始化、执行、返回等操作，mainwindow只负责插件管理者的创建。
		2. xxx
	- 视图，由于要实现图像的显示以及平移缩放的功能，可以使用Qt提供的**Graphics view framwork**。
	- 缩略图框，负责管理item，每个item代表一个被选择的图像。
	- 生产者，读取图片进入队列，由于要循环运行，避免主线程卡死，将这个类继承自QThread。
	- 消费者，进入队列获取图像，再调用插件管理者的api。也继承自QThread，原因同上。

- 使用**顺序图**对算法循环运行的流程进行uml建模
![Pasted image 20240115225020](https://github.com/JLer-chen/MVtoolbox/assets/53033561/c55f73fd-0093-4755-9614-a3c2d4188cf6)
## 总结

### 重难点

#### 视图编程
- 使用Qt提供的*Graphics view framwork*来完成图像平移和缩放的功能。
- 核心思路是使用自定义类继承自*QGraphicsView*，并重新实现一系列鼠标滚轮事件。通过对视图的平移和缩放来实现对*用户可见的图像的平移和缩放*。
- 视图的平移主要通过centerOn函数实现，缩放通过scale函数实现。
#### 图像不及时更新问题
- 为什么在循环模式下，视图中的图像不更新。根本原因是对信号-槽机制的理解不够深入。
- 误以为在同一个主线程内，emit一个信号后，对应的槽函数会被立刻执行。
- 然而在这个场景下，消费者线程可能已经发送了数十个信号，主线程在响应第一个信号时能够进入插件管理者对象的process，但在process中会发送信号给视图，视图中的**槽函数是不会被立刻执行的，这不是直接调用函数**。猜测发送给视图的信号会在主线程的某个数据结构里排队。
- 而且这个情形下（需要处理4000张图片），主界面会异常卡顿。原因可能主线程是有大量的信号要处理（每一张图片对应一个信号），这是一个耗时操作 ，主线程回到事件循环的时间较少，无法及时处理界面上产生的事件。
- 深刻理解主线程不能有耗时操作。

#### 死锁问题
[详情页](other/2024-01-12.md)
#### 图像不显示问题
- 由插件发送给主程序的经由Canny处理的QImage无法被QPixmap的fromImage正确处理，但如果将这个图片保存到本地，主程序再从本地读取QImage，fromImage函数就能够正常处理。
- 如果插件发送RGB888格式的图片，主程序也能够正常读取。针对这个问题，使用debugger断点查看，确定是qt内部的哪个函数出了问题。发现栈中有a函数调用b函数，b函数返回后，a函数接着调用b函数，陷入循环，程序崩溃。
- 由于这种方式使得程序多了一次读io的过程，经过实测一张图片读一次会产生0~1ms的耗时。次性能问题待后续版本修复。
![Pasted image 20240102222501](https://github.com/JLer-chen/MVtoolbox/assets/53033561/aca22fa5-7198-423e-b349-4ce495a0655c)


### 提高的方向

#### 具体组件性能提升
##### listiamge
- 几千个图形项在每次更新readlist后，之前的是否销毁
- open时，加载图像的速度，或者用户体验如何提升。进度条
- 原4000张图像17MB，但加载进来后，有823MB。如何优化。
##### 生产者消费者
- 每次生产者和消费者进入临界区只处理一张图片，是不是每次尽可能处理多张图片会提高性能
#### 功能拓展
- 数据库功能
- 网络功能
- ui界面的显示日志功能
- 界面外观 

#### 设计模式以及cpp11语法
